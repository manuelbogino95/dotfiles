#!/bin/bash
set -eufo pipefail

{{- if eq .chezmoi.os "darwin" }}
echo "üçè  Setting macOS defaults"

# Close System Preferences to prevent conflicts
osascript -e 'tell application "System Preferences" to quit'

echo "üìö  Show the ~/Library folder"
chflags nohidden ~/Library

# General System Improvements
echo "‚ö°  Disable the sound effects on boot (requires admin password)"
sudo nvram SystemAudioVolume=" "

echo "‚ö°  Disable automatic capitalization, smart dashes, period substitution and spell check"
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

echo "‚ö°  Enable 'natural' scrolling"
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool true

# Keyboard Improvements
echo "‚å®Ô∏è  Set AppleEnabledInputSources (US Keyboard Layout)"
defaults write com.apple.HIToolbox AppleEnabledInputSources -array \
  '<dict>
    <key>InputSourceKind</key><string>Keyboard Layout</string>
    <key>KeyboardLayout ID</key><integer>252</integer>
    <key>KeyboardLayout Name</key><string>ABC</string>
  </dict>'

echo "‚å®Ô∏è  Set AppleSelectedInputSources (US Keyboard Layout)"
defaults write com.apple.HIToolbox AppleSelectedInputSources -array \
  '<dict>
    <key>InputSourceKind</key><string>Keyboard Layout</string>
    <key>KeyboardLayout ID</key><integer>252</integer>
    <key>KeyboardLayout Name</key><string>ABC</string>
  </dict>'

echo "‚å®Ô∏è  Set AppleCurrentKeyboardLayoutInputSourceID to ABC"
defaults write com.apple.HIToolbox AppleCurrentKeyboardLayoutInputSourceID -string "com.apple.keylayout.ABC"

echo "‚å®Ô∏è  Enable keyboard navigation"
defaults write NSGlobalDomain AppleKeyboardUIMode -int 2

echo "‚å®Ô∏è  Set blazingly fast keyboard repeat rate"
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 15

echo "‚å®Ô∏è  Disable press-and-hold for keys in favor of key repeat"
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Trackpad Improvements
echo "üñ±Ô∏è  Set scroll direction to normal"
defaults write -g com.apple.swipescrolldirection -bool false

echo "üñ±Ô∏è  Enable trackpad right secondary corner click"
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults write com.apple.AppleMultitouchTrackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.AppleMultitouchTrackpad TrackpadRightClick -bool true
defaults -currentHost write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1
defaults -currentHost write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true

echo "üñ±Ô∏è  Enable tap to click for this user and for the login screen"
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
# Enable tap to click for login screen (requires admin)
sudo defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true 2>/dev/null || echo "‚ÑπÔ∏è  Could not set login screen tap-to-click (normal if not admin)"

echo "üñ±Ô∏è  Set trackpad tracking speed"
defaults write -g com.apple.trackpad.scaling -float 1

echo "üñ±Ô∏è  Enable three finger drag"
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag -bool true
defaults write com.apple.AppleMultitouchTrackpad TrackpadThreeFingerDrag -bool true

# Dock Improvements
echo "üíà  Automatically hide and show the dock"
defaults write com.apple.dock autohide -bool true

echo "üíà  Make dock icons smaller (48px)"
defaults write com.apple.dock tilesize -int 48

echo "üíà  Remove the auto-hiding dock delay"
defaults write com.apple.dock autohide-delay -float 0

echo "üíà  Remove the animation when hiding/showing the dock"
defaults write com.apple.dock autohide-time-modifier -float 0

echo "üíà  Don't show recent applications in dock"
defaults write com.apple.dock show-recents -bool false

echo "üíà  Enable spring loading for all dock items"
defaults write com.apple.dock enable-spring-load-actions-on-all-items -bool true

# Finder Improvements
echo "üìÅ  Show hidden files by default"
defaults write com.apple.finder AppleShowAllFiles -bool true

echo "üìÅ  Show all filename extensions"
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

echo "üìÅ  Show status bar"
defaults write com.apple.finder ShowStatusBar -bool true

echo "üìÅ  Show path bar"
defaults write com.apple.finder ShowPathbar -bool true

echo "üìÅ  Show toolbar"
defaults write com.apple.finder ShowToolbar -bool true

echo "üìÅ  Hide recent files in Finder sidebar"
defaults write com.apple.finder ShowRecentTags -bool false

echo "üìÅ  Keep folders on top when sorting by name"
defaults write com.apple.finder _FXSortFoldersFirst -bool true

echo "üìÅ  When performing a search, search the current folder by default"
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

echo "üìÅ  Disable the warning when changing a file extension"
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

echo "üìÅ  Avoid creating .DS_Store files on network or USB volumes"
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

echo "üìÅ  Sort Finder icons by name"
/usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "‚ÑπÔ∏è  Could not set desktop icon arrangement"
/usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "‚ÑπÔ∏è  Could not set folder icon arrangement"
/usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "‚ÑπÔ∏è  Could not set standard icon arrangement"

echo "üìÅ  Set Finder icons size"
/usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "‚ÑπÔ∏è  Could not set desktop icon size"
/usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "‚ÑπÔ∏è  Could not set folder icon size"
/usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "‚ÑπÔ∏è  Could not set standard icon size"

echo "üìÅ  Set Finder preferred view style to list view"
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# Screenshots
echo "üì∏  Save screenshots to the Downloads folder"
defaults write com.apple.screencapture location -string "${HOME}/Downloads"

echo "üì∏  Save screenshots in PNG format (other options: BMP, GIF, JPG, PDF, TIFF)"
defaults write com.apple.screencapture type -string "png"

echo "üì∏  Disable shadow in screenshots"
defaults write com.apple.screencapture disable-shadow -bool true

# Menu Bar Improvements
echo "üìä  Show battery percentage in menu bar"
defaults write com.apple.menuextra.battery ShowPercent -bool true

echo "üì∂  Show Bluetooth icon in menu bar"
defaults write com.apple.controlcenter "NSStatusItem Visible Bluetooth" -bool true

echo "üë§  Show user switch (fast user switching) in menu bar"
sudo defaults write /Library/Preferences/.GlobalPreferences MultipleSessionEnabled -bool true
sudo defaults write /Library/Preferences/com.apple.loginwindow.plist SHOWFULLNAME -bool true
defaults write com.apple.controlcenter "NSStatusItem Visible UserSwitcher" -bool true

# Activity Monitor
echo "üîç  Show the main window when launching Activity Monitor"
defaults write com.apple.ActivityMonitor OpenMainWindow -bool true

echo "üîç  Show all processes in Activity Monitor"
defaults write com.apple.ActivityMonitor ShowCategory -int 0

# TextEdit
echo "üìù  Use plain text mode for new TextEdit documents"
defaults write com.apple.TextEdit RichText -int 0

echo "üìù  Open and save files as UTF-8 in TextEdit"
defaults write com.apple.TextEdit PlainTextEncoding -int 4
defaults write com.apple.TextEdit PlainTextEncodingForWrite -int 4

echo "üì±  Set 'Open at login' applications"

loginItems=(
  "Raycast"
  "BetterDisplay"
)

for app in "${loginItems[@]}"; do
  if [ -d "/Applications/$app.app" ]; then
    osascript -e "tell application \"System Events\" to make login item at end with properties {name: \"$app\", path: \"/Applications/$app.app\", hidden:true}" 2>/dev/null && echo "‚úÖ  $app added to login items" || echo "‚ÑπÔ∏è  Could not add $app to login items"
  else
    echo "‚ùå  $app not found in /Applications"
  fi
done

echo "üîÑ  Restarting affected applications..."

for app in "Activity Monitor" \
	"cfprefsd" \
	"Dock" \
	"Finder" \
	"Safari" \
	"SystemUIServer"; do
	killall "${app}" &> /dev/null || true
done

echo "‚úÖ  macOS system preferences have been configured!"
echo "üìã  Note: Some changes may require a logout/restart to take effect."

{{ end -}}
